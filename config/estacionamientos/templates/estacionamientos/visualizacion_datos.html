{% extends "base.html" %}
{% load static %}

{% block title %}Consultar datos{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/visualizacion_datos.css' %}">
{% endblock %}

{% block content %}

<section class="card">
  <div class="row row--between">
    <h1 style="margin:0">Consultar datos</h1>
    <a class="btn btn--siga btn--sm" href="{% url 'panel_home' %}">Volver</a>
  </div>

  {% if not opcionSeleccionada %}
    <p class="muted">Seleccione opción de búsqueda</p>

    <div class="options-grid">
      <form method="get" class="option">
        <input type="hidden" name="op1" value="1">
        <button type="submit" class="option__btn">
          <span>Consultar entrada/salida de un día</span>
          <span class="option__chev" aria-hidden="true">›</span>
        </button>
      </form>

      <form method="get" class="option">
        <input type="hidden" name="op2" value="1">
        <button type="submit" class="option__btn">
          <span>Historial de un vehículo por patente</span>
          <span class="option__chev" aria-hidden="true">›</span>
        </button>
      </form>

      <form method="get" class="option">
        <input type="hidden" name="op3" value="1">
        <button type="submit" class="option__btn">
          <span>Filtrar registros por zona y fecha</span>
          <span class="option__chev" aria-hidden="true">›</span>
        </button>
      </form>
    </div>

  {% else %}

    {# ================= Opción 1 ================= #}
    {% if opcionSeleccionada == 1 %}
      <h2 class="sub">Consultar entrada/salida de un día</h2>

      {% if not registros %}
        <form method="get" class="form-grid">
          <div class="field">
            <label class="label">Seleccione un día</label>
            <input class="input" type="date" name="dia">
          </div>
          <input type="hidden" name="op1" value="1">
          <div class="actions">
            <button class="btn btn--primary" type="submit">Consultar</button>
            <a class="btn btn--ghost" href="{% url 'visualizacion_datos' %}">Volver a opciones</a>
          </div>
        </form>

      {% else %}
        {% for zona in registros %}
          <section class="zona-block">
            <header class="zona-block__header">
              <h3 class="zona-title">{{ zona.nombre_zona }}</h3>
            </header>

            <div class="table-wrap">
              <table class="table table--sticky table--stack">
                <thead>
                  <tr>
                    <th>Patente</th>
                    <th>Conductor</th>
                    <th>RUT</th>
                    <th>Entrada</th>
                    <th>Salida</th>
                  </tr>
                </thead>
                <tbody>
                  {% for vehiculo in zona.registros.all %}
                    <tr>
                      <td data-label="Patente">{{ vehiculo.patente }}</td>
                      <td data-label="Conductor">{{ vehiculo.nombre_conductor }} {{ vehiculo.apellido_conductor }}</td>
                      <td data-label="RUT">{{ vehiculo.rut_conductor }}</td>
                      <td data-label="Entrada">{{ vehiculo.hora_entrada|date:"H:i:s" }}</td>
                      <td data-label="Salida">{{ vehiculo.hora_salida|date:"H:i:s" }}</td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td class="empty" colspan="5">Sin registro de vehículos.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </section>
        {% endfor %}

        <div class="actions mt">
          <a class="btn btn--ghost" href="{% url 'visualizacion_datos' %}">Volver a opciones</a>
        </div>
      {% endif %}
    {% endif %}

    {# ================= Opción 2 ================= #}
    {% if opcionSeleccionada == 2 %}
      <h2 class="sub">Historial de un vehículo por patente</h2>

      {% if not registros %}
        <form method="get" class="form-grid">
          <div class="field">
            <label class="label">Patente</label>
            <input class="input" type="text" name="patente" placeholder="ABC123 o AA-BB-11">
          </div>
          <input type="hidden" name="op2" value="1">
          <div class="actions">
            <button class="btn btn--primary" type="submit">Consultar</button>
            <a class="btn btn--ghost" href="{% url 'visualizacion_datos' %}">Volver a opciones</a>
          </div>
        </form>

      {% else %}
        <h3 class="sub">Patente consultada: <strong>{{ patenteConsultada }}</strong></h3>

        <div class="table-wrap">
          <table class="table table--sticky table--stack">
            <thead>
              <tr>
                <th>Conductor</th>
                <th>RUT</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Zona</th>
              </tr>
            </thead>
            <tbody>
              {% for reg in registros %}
                <tr>
                  <td data-label="Conductor">{{ reg.nombre_conductor }} {{ reg.apellido_conductor }}</td>
                  <td data-label="RUT">{{ reg.rut_conductor }}</td>
                  <td data-label="Entrada">{{ reg.hora_entrada }}</td>
                  <td data-label="Salida">{{ reg.hora_salida }}</td>
                  <td data-label="Zona">{{ reg.zona_estacionamiento.nombre_zona }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td class="empty" colspan="5">Sin registros del vehículo.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="actions mt">
          <a class="btn btn--ghost" href="{% url 'visualizacion_datos' %}">Volver a opciones</a>
        </div>
      {% endif %}
    {% endif %}

    {# ================= Opción 3 ================= #}
    {% if opcionSeleccionada == 3 %}
      <h2 class="sub">Filtrar registros por zona y fecha</h2>

      {% if not registros %}
        <form method="get" class="form-grid">
          <div class="field">
            <label class="label">Zona</label>
            <select class="select" name="zona" required>
              <option value="">-- Seleccionar zona --</option>
              {% for z in zonas %}
                <option value="{{ z.id }}">{{ z.nombre_zona }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label class="label">Día</label>
            <input class="input" type="date" name="dia">
          </div>
          <input type="hidden" name="op3" value="1">
          <div class="actions">
            <button class="btn btn--primary" type="submit">Consultar</button>
            <a class="btn btn--ghost" href="{% url 'visualizacion_datos' %}">Volver a opciones</a>
          </div>
        </form>

      {% else %}
        <h3 class="sub">Zona: <strong>{{ zona }}</strong> &middot; Día: <strong>{{ dia }}</strong></h3>

        <div class="table-wrap">
          <table class="table table--sticky table--stack">
            <thead>
              <tr>
                <th>Conductor</th>
                <th>RUT</th>
                <th>Patente</th>
                <th>Entrada</th>
                <th>Salida</th>
              </tr>
            </thead>
            <tbody>
              {% for reg in registros %}
                <tr>
                  <td data-label="Conductor">{{ reg.nombre_conductor }} {{ reg.apellido_conductor }}</td>
                  <td data-label="RUT">{{ reg.rut_conductor }}</td>
                  <td data-label="Patente">{{ reg.patente }}</td>
                  <td data-label="Entrada">{{ reg.hora_entrada }}</td>
                  <td data-label="Salida">{{ reg.hora_salida }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td class="empty" colspan="5">Sin registros de vehículos.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="actions mt">
          <a class="btn btn--ghost" href="{% url 'visualizacion_datos' %}">Volver a opciones</a>
        </div>
      {% endif %}
    {% endif %}

  {% endif %}
</section>

{% endblock %}
