{% extends "base.html" %}
{% load static %}

{% block title %}Registrar salida{% endblock %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/registrar_salida.css' %}">
{% endblock %}

{% block content %}
<section class="card salida">
  <header class="salida__header">
    <h1 class="salida__title">Registrar salida de vehículo</h1>
     <!-- FOKIN BOTON -->
    <a class="btn btn--siga btn--sm"
   href="{% url 'panel_home' %}">
  Volver
</a>
  </header>

  {% if error %}
    <div class="alert alert--error" role="alert">{{ error }}</div>
  {% endif %}

  {% if not zona_seleccionada %}
    <!-- PASO 1: Elegir zona (GET) -->
    <h2 class="sub">Seleccione una zona de estacionamiento</h2>
    <form method="get" class="form">
      <div class="form-control">
        <label class="label" for="zona">Zona</label>
        <select id="zona" name="zona" class="select" required>
          <option value="">-- Seleccionar zona --</option>
          {% for z in zonas %}
            <option value="{{ z.id }}">{{ z.nombre_zona }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn--primary">Continuar</button>
      </div>
    </form>

  {% else %}
    <!-- PASO 2: Listar vehículos activos (cada tarjeta hace POST) -->
    <h2 class="sub">Zona seleccionada: {{ zona_seleccionada.nombre_zona }}</h2>

    {% if vehiculos %}
      <p>Haz clic en un vehículo para registrar su salida:</p>

      <ul class="vehiculos-grid">
        {% for v in vehiculos %}
          <li>
            <form method="post" action="">
              {% csrf_token %}
              <input type="hidden" name="zona" value="{{ zona_seleccionada.id }}">
              <input type="hidden" name="patente" value="{{ v.patente }}">

              <button type="submit" class="vehiculo-btn" title="Registrar salida de {{ v.patente }}">
                <div class="vehiculo-meta">
                  <span class="patente">{{ v.patente }}</span>
                  <span class="conductor">{{ v.nombre_conductor }} {{ v.apellido_conductor|default:'' }}</span>
                  <small class="hora">Hora entrada: {{ v.hora_entrada|date:"H:i d/m/Y" }}</small>
                </div>
                <span class="vehiculo-chev" aria-hidden="true">›</span>
              </button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">No hay vehículos estacionados actualmente en esta zona.</div>
    {% endif %}

    <p class="volver-zona">
      <a class="btn btn--ghost" href="{% url 'registrar_salida' %}">Elegir otra zona</a>
    </p>
  {% endif %}
</section>
{% endblock %}
